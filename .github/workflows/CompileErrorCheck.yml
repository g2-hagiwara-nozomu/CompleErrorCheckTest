name: CheckCompileError
on:
  pull_request:
    types: [closed]
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  PULL_REQ_URL: ${{ github.event.pull_request.comments_url }}
  GIT_SHA: ${{ github.sha }}
  GIT_ACTOR: ${{github.actor}}
  UNITY_VERSION: 2020.3.18f1
  PROJECT_PATH: ${{ github.workspace }}/CompleErrorCheskTest
jobs:
  build:
    name: Check Compile Error
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
        with:
          clean: false
          lfs: false

      # 準備
      - name: Ready
        run: |
          echo Ready
          echo from $GITHUB_REF
          echo at ${{ github.workspace }}

      # Unityを開いてエラーチェック
      - name: Open Unity
        env:
          UNITY_PATH: /Applications/Unity/Hub/Editor/${{env.UNITY_VERSION}}/Unity.app/Contents/MacOS/Unity
        run: |
          echo cheking compile error 
          echo unity path: $UNITY_PATH 
          echo project path: $PROJECT_PATH 
          $UNITY_PATH -quit -batchmode  -projectPath $PROJECT_PATH

      # 失敗メッセージ
      - name: GitHubのPullRequestに失敗メッセージを送信
        if: failure()
        env:
          TEXT: "コンパイルエラーが出ています"
        run: |
          curl -X POST \
               -H "Authorization: token ${GITHUB_TOKEN}" \
               -d "{\"body\": \"${TEXT}　${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GIT_SHA} \"}" \
               ${PULL_REQ_URL}

      # 成功メッセージ
      - name: GitHubのPullRequestに成功メッセージを送信
        if: success()
        env:
          TEXT: "コンパイルチェック問題なし"
        run: |
          curl -X POST \
               -H "Authorization: token ${GITHUB_TOKEN}" \
               -d "{\"body\": \"${TEXT}　${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GIT_SHA} \"}" \
               ${PULL_REQ_URL}
